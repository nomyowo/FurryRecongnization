{% extends "base.html" %}

{% block title %}Query{% endblock %}

{% block content %}
<div class="row">

    {% if current_label is none %}
    <!-- Query Labels / Folders View -->
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Query <small class="text-muted fs-6">Upload query images</small></h2>
             <a href="/query/download_all" class="btn btn-outline-success">
                <i class="bi bi-download"></i> Download All
            </a>
        </div>

        <!-- Upload Form -->
        <div class="card mb-4 border-success">
            <div class="card-header bg-success text-white">
                Upload New Query Images
            </div>
            <div class="card-body">
                 <form action="/query/upload" method="post" enctype="multipart/form-data" class="row g-3">
                    <div class="col-md-4">
                        <label for="files" class="form-label">Select Files</label>
                        <input type="file" class="form-control" name="files" multiple>
                    </div>
                    <div class="col-md-4">
                        <label for="folder" class="form-label">Select Folder</label>
                        <input type="file" class="form-control" name="files" webkitdirectory multiple>
                    </div>

                    <div class="col-md-4">
                         <label for="label" class="form-label">Label (optional)</label>
                        <input type="text" class="form-control" name="label" placeholder="Labels (separated by , or ，)">
                    </div>
                    <div class="col-12 mt-3 text-end">
                        <button type="submit" class="btn btn-success">Upload</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-4">
            {% if labels %}
                {% for row in labels %}
                <div class="col">
                    <a href="/query?label={{ row.label }}" class="text-decoration-none text-dark">
                        <div class="card h-100 text-center folder-card border-0 shadow-sm">
                            <div class="card-body">
                                <i class="bi bi-folder-fill folder-icon {% if row.label == '未检测到' %}text-warning{% else %}text-success{% endif %}"></i>
                                <h5 class="card-title mt-2 text-truncate" title="{{ row.label }}">{{ row.label }}</h5>
                                <p class="card-text text-muted small">{{ row.count }} items</p>
                            </div>
                        </div>
                    </a>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <p class="alert alert-info">No query groups found. Upload images to create a group.</p>
                </div>
            {% endif %}
        </div>
    </div>

    {% else %}
    <!-- Image Gallery View -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <a href="/query" class="text-decoration-none me-2"><i class="bi bi-arrow-left-circle text-success"></i></a>
                Query Group: <span class="text-success">{{ current_label }}</span>
            </h2>
            <a href="/query/download_label?label={{ current_label }}" class="btn btn-outline-success">
                <i class="bi bi-download"></i> Download Folder
            </a>
        </div>

        <div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-4">
            {% if images %}
                {% for image in images %}
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <a href="/files/query/{{ image.filename }}" target="_blank">
                             <img src="/files/query/{{ image.filename }}" class="card-img-top image-card-img" alt="{{ image.filename }}">
                        </a>
                        <div class="card-body p-2">
                             <p class="card-text text-truncate small mb-1" title="{{ image.filename }}">{{ image.filename }}</p>
                            <small class="text-muted d-block mb-2">{{ image.timestamp }}</small>
                             <form action="/update_label/{{ image.id }}" method="post" class="mt-2">
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" name="label" value="{{ image.label if image.label else '' }}" placeholder="Label">
                                    <input type="hidden" name="redirect_to" value="/query?label={{ current_label }}">
                                    <button class="btn btn-outline-secondary" type="submit" title="Update Label"><i class="bi bi-pencil-square"></i></button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <p class="alert alert-warning">No images found for this label.</p>
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

