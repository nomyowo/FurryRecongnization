{% extends "base.html" %}

{% block title %}Library{% endblock %}

{% block content %}
<div class="row">

    {% if current_label is none %}
    <!-- Folder View (Label List) -->
    <div class="col-12 mb-4">
        <h2>训练图库</h2>
        <p class="text-muted">点击文件夹预览图像</p>

        <!-- Upload Form -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                上传新图片集
            </div>
            <div class="card-body">
                <form action="/lib/upload" method="post" enctype="multipart/form-data" class="row g-3 align-items-center">
                    <div class="col-auto">
                        <label for="files" class="visually-hidden">Files</label>
                        <input type="file" class="form-control" id="files" name="files" multiple required>
                    </div>
                    <div class="col-auto">
                        <label for="label" class="visually-hidden">Label</label>
                        <input type="text" class="form-control" id="label" name="label" placeholder="兽装名称" required>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary">上传</button>
                    </div>
                </form>
            </div>
        </div>

        <form action="/lib/delete_folders_bulk" method="post" id="folderDeleteForm">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAllFolders">
                    <label class="form-check-label" for="selectAllFolders">全选</label>
                </div>
                <button type="submit" class="btn btn-danger btn-sm" id="deleteFolderBtn" disabled onclick="return confirm('Are you sure you want to delete selected folders and all their images?');">
                    <i class="bi bi-trash"></i> 删除所选类别
                </button>
            </div>

            <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-4">
                {% if labels %}
                    {% for row in labels %}
                    <div class="col">
                            <div class="card h-100 text-center folder-card border-0 shadow-sm position-relative">
                                <div class="position-absolute top-0 start-0 p-2" style="z-index: 10;">
                                     <input class="form-check-input folder-checkbox" type="checkbox" name="labels" value="{{ row.label }}">
                                </div>
                                <div class="card-body">
                                    <a href="/lib?label={{ row.label }}" class="text-decoration-none text-dark stretched-link">
                                        <i class="bi bi-folder-fill folder-icon"></i>
                                        <h5 class="card-title mt-2 text-truncate" title="{{ row.label }}">{{ row.label }}</h5>
                                    </a>
                                    <p class="card-text text-muted small">{{ row.count }} 张图像</p>
                                </div>
                            </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <p class="alert alert-info">暂无文件，请先上传图像文件</p>
                    </div>
                {% endif %}
            </div>
        </form>

        <script>
            document.getElementById('selectAllFolders').addEventListener('change', function() {
                var checkboxes = document.querySelectorAll('.folder-checkbox');
                for (var checkbox of checkboxes) {
                    checkbox.checked = this.checked;
                }
                updateFolderBtnState();
            });

            var folderCheckboxes = document.querySelectorAll('.folder-checkbox');
            for (var checkbox of folderCheckboxes) {
                checkbox.addEventListener('change', updateFolderBtnState);
            }

            function updateFolderBtnState() {
                var checkedCount = document.querySelectorAll('.folder-checkbox:checked').length;
                document.getElementById('deleteFolderBtn').disabled = checkedCount === 0;
            }
        </script>
    </div>

    {% else %}
    <!-- Image Gallery View -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <a href="/lib" class="text-decoration-none me-2"><i class="bi bi-arrow-left-circle"></i></a>
                名称: <span class="text-primary">{{ current_label }}</span>
            </h2>
            <!-- Upload to this folder shortcut -->
             <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#uploadCollapse" aria-expanded="false" aria-controls="uploadCollapse">
                向该类别添加图片
            </button>
        </div>

        <div class="collapse mb-4" id="uploadCollapse">
            <div class="card card-body">
                 <form action="/lib/upload" method="post" enctype="multipart/form-data" class="row g-3">
                    <input type="hidden" name="label" value="{{ current_label }}">
                    <div class="col-md-10">
                        <input type="file" class="form-control" name="files" multiple required>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">上传</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Bulk Delete Form (Hidden) -->
        <form action="/lib/delete_bulk" method="post" id="bulkDeleteForm">
             <input type="hidden" name="redirect_to" value="/lib?label={{ current_label }}">
             <div id="bulkDeleteInputs"></div>
        </form>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="selectAllImages">
                <label class="form-check-label" for="selectAllImages">全选</label>
            </div>
            <button type="button" class="btn btn-danger btn-sm" id="deleteImageBtn" disabled onclick="submitBulkDelete()">
                <i class="bi bi-trash"></i> 删除所选照片
            </button>
        </div>

        <div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-4">
            {% if images %}
                {% for image in images %}
                <div class="col">
                    <div class="card h-100 shadow-sm position-relative">
                        <div class="position-absolute top-0 start-0 p-2" style="z-index: 10;">
                            <input class="form-check-input image-checkbox" type="checkbox" value="{{ image.id }}">
                        </div>
                        <a href="/files/lib/{{ image.filename }}" target="_blank">
                            <img src="/files/lib/{{ image.filename }}" class="card-img-top image-card-img" alt="{{ image.filename }}">
                        </a>
                        <div class="card-body p-2">
                            <p class="card-text text-truncate small mb-1" title="{{ image.filename }}">文件名：{{ image.filename }}</p>
                            <small class="text-muted d-block mb-2 text-truncate" style="text-overflow: ellipsis">上传时间：{{ image.timestamp }}</small>
                            <form action="/update_label/{{ image.id }}" method="post" class="mt-2">
                                <div class="input-group input-group-sm">
                                    <p class="card-text text-truncate small mb-1" >名称：</p>
                                    <input type="text" class="form-control" name="label" value="{{ image.label }}" placeholder="Label">
                                    <input type="hidden" name="redirect_to" value="/lib?label={{ current_label }}">
                                    <button class="btn btn-outline-secondary" type="submit" title="Update Label"><i class="bi bi-pencil-square"></i></button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <p class="alert alert-warning">该分类无图像</p>
                </div>
            {% endif %}
        </div>

        <script>
            document.getElementById('selectAllImages').addEventListener('change', function() {
                var checkboxes = document.querySelectorAll('.image-checkbox');
                for (var checkbox of checkboxes) {
                    checkbox.checked = this.checked;
                }
                updateImageBtnState();
            });

            var imageCheckboxes = document.querySelectorAll('.image-checkbox');
            for (var checkbox of imageCheckboxes) {
                checkbox.addEventListener('change', updateImageBtnState);
            }

            function updateImageBtnState() {
                var checkedCount = document.querySelectorAll('.image-checkbox:checked').length;
                document.getElementById('deleteImageBtn').disabled = checkedCount === 0;
            }

            function submitBulkDelete() {
                if (!confirm('Delete selected images?')) return;

                document.getElementById('deleteImageBtn').disabled = true;

                var form = document.getElementById('bulkDeleteForm');
                var inputsContainer = document.getElementById('bulkDeleteInputs');
                inputsContainer.innerHTML = '';

                var checkboxes = document.querySelectorAll('.image-checkbox:checked');
                checkboxes.forEach(function(cb) {
                    var input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'image_ids';
                    input.value = cb.value;
                    inputsContainer.appendChild(input);
                });

                showLoading();
                form.submit();
            }
        </script>
    </div>
    {% endif %}

</div>
{% endblock %}

