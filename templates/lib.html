{% extends "base.html" %}

{% block title %}Library{% endblock %}

{% block content %}
<div class="row">

    {% if current_label is none %}
    <!-- Folder View (Label List) -->
    <div class="col-12 mb-4">
        <h2>Library</h2>
        <p class="text-muted">Select a folder to view images.</p>

        <!-- Upload Form -->
        <div class="card mb-4">
            <div class="card-header">
                Upload New Images
            </div>
            <div class="card-body">
                <form action="/lib/upload" method="post" enctype="multipart/form-data" class="row g-3 align-items-center">
                    <div class="col-auto">
                        <label for="files" class="visually-hidden">Files</label>
                        <input type="file" class="form-control" id="files" name="files" multiple required>
                    </div>
                    <div class="col-auto">
                        <label for="label" class="visually-hidden">Label</label>
                        <input type="text" class="form-control" id="label" name="label" placeholder="Label/Folder Name" required>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary">Upload</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-4">
            {% if labels %}
                {% for row in labels %}
                <div class="col">
                    <a href="/lib?label={{ row.label }}" class="text-decoration-none text-dark">
                        <div class="card h-100 text-center folder-card border-0 shadow-sm">
                            <div class="card-body">
                                <i class="bi bi-folder-fill folder-icon"></i>
                                <h5 class="card-title mt-2 text-truncate" title="{{ row.label }}">{{ row.label }}</h5>
                                <p class="card-text text-muted small">{{ row.count }} items</p>
                            </div>
                        </div>
                    </a>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <p class="alert alert-info">No folders found. Upload images to create a folder.</p>
                </div>
            {% endif %}
        </div>
    </div>

    {% else %}
    <!-- Image Gallery View -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <a href="/lib" class="text-decoration-none me-2"><i class="bi bi-arrow-left-circle"></i></a>
                Folder: <span class="text-primary">{{ current_label }}</span>
            </h2>
            <!-- Upload to this folder shortcut -->
             <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#uploadCollapse" aria-expanded="false" aria-controls="uploadCollapse">
                Add Images to this Folder
            </button>
        </div>

        <div class="collapse mb-4" id="uploadCollapse">
            <div class="card card-body">
                 <form action="/lib/upload" method="post" enctype="multipart/form-data" class="row g-3">
                    <input type="hidden" name="label" value="{{ current_label }}">
                    <div class="col-md-10">
                        <input type="file" class="form-control" name="files" multiple required>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Upload</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-4">
            {% if images %}
                {% for image in images %}
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <a href="/files/lib/{{ image.filename }}" target="_blank">
                            <img src="/files/lib/{{ image.filename }}" class="card-img-top image-card-img" alt="{{ image.filename }}">
                        </a>
                        <div class="card-body p-2">
                            <p class="card-text text-truncate small mb-1" title="{{ image.filename }}">{{ image.filename }}</p>
                            <small class="text-muted d-block mb-2">{{ image.timestamp }}</small>
                            <form action="/update_label/{{ image.id }}" method="post" class="mt-2">
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" name="label" value="{{ image.label }}" placeholder="Label">
                                    <input type="hidden" name="redirect_to" value="/lib?label={{ current_label }}">
                                    <button class="btn btn-outline-secondary" type="submit" title="Update Label"><i class="bi bi-pencil-square"></i></button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <p class="alert alert-warning">No images found in this folder.</p>
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

